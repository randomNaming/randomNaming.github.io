<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>æ²ªä¹é”¦å…¬å¯“ç³»ç»Ÿï¼ˆæ•°æ®æœ¬åœ°ç‰ˆï¼‰</title>
<style>
/* ------------------------------------------- */
/* CSS æ ·å¼ï¼šæ©™è‰²ä¸“ä¸šé£æ ¼ */
/* ------------------------------------------- */
:root{
  --primary:#ff7f32;     /* ä¸»è‰²ï¼šæš–æ©™è‰² (Primary Orange) */
  --accent:#1a73e8;      /* å¼ºè°ƒè‰²ï¼šä¸“ä¸šè“ (Accent Blue) */
  --bg:#f8f9fa;          /* é¡µé¢èƒŒæ™¯ï¼šææµ…ç° */
  --card-bg:#fff;        /* å¡ç‰‡èƒŒæ™¯ï¼šç™½è‰² */
  --text:#333;           /* ä¸»è¦æ–‡æœ¬è‰² */
  --muted:#888;          /* è¾…åŠ©æ–‡æœ¬è‰² */
  --border:#eee;         /* è¾¹æ¡†è‰² */
  --danger:#e74c3c;      /* å±é™©/é”™è¯¯è‰² */
  --ok:#24b36b;          /* æˆåŠŸè‰² */
  --shadow: 0 4px 16px rgba(0, 0, 0, 0.05); /* æŸ”å’Œé˜´å½± */
}
*{box-sizing:border-box}html,body{margin:0;height:100%}
body{font-family:-apple-system,system-ui,"Microsoft Yahei",Arial;background:var(--bg);color:var(--text);line-height:1.6}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
a{text-decoration:none;color:var(--primary)}

/* å¤´éƒ¨å¯¼èˆª - å“ç‰Œåç§°æ”¾å¤§ */
.header{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 20px;
  position:sticky;top:0;left:0;z-index:90;
  background:var(--card-bg);
  border-bottom:1px solid var(--border);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
}
.brand{font-weight:900;font-size:26px;color:var(--primary);}
.header-right{display:flex;gap:15px;align-items:center;}
.header-link{color:var(--text);padding:8px 12px;border-radius:6px;transition:.2s;border:1px solid transparent;}
.header-link:hover{background:var(--primary);color:#fff;}
.header-link.accent{color:var(--accent);border-color:var(--accent);}

/* ä¸»è§†è§‰ç„¦ç‚¹å›¾ (æ¨¡æ‹Ÿè½®æ’­å›¾æ•ˆæœ) */
#hero{
  height:300px;
  background:linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), 
             url('https://picsum.photos/1200/300?random=1') center / cover no-repeat;
  display:flex;align-items:center;justify-content:center;
  border-radius:12px;margin-bottom:20px;
  box-shadow:var(--shadow);
  color:white;font-size:2.5em;font-weight:bold;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  transition: background-image 1s;
}
#hero h1{margin:0;font-size:1.5em;padding:10px 20px;background:rgba(0,0,0,0.3);border-radius:8px;}

/* å†…å®¹åŒº */
.content{background:var(--bg);border-radius:14px;}
.topnav{display:flex;gap:12px;flex-wrap:wrap;padding:15px 0;border-bottom:1px solid var(--border);margin-bottom:20px;}
.tab{border:none;background:#fefefe;color:var(--text);padding:10px 18px;border-radius:8px;cursor:pointer;transition:.2s;font-weight:600;border:1px solid #ddd;}
.tab.active,.tab:hover{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 4px 8px rgba(255, 127, 50, 0.3);}
.notice{background:#fff8f2;color:var(--primary);border-left:4px solid var(--primary);border-radius:6px;padding:12px 18px;margin-bottom:20px;font-weight:500;}

/* ä¸»è¦ç½‘æ ¼å¸ƒå±€ */
.grid{display:grid;grid-template-columns:3fr 1fr;gap:20px;padding-bottom:20px;}
.card{background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0, 0, 0, 0.04);}

/* æˆ¿æºåˆ—è¡¨å¡ç‰‡ */
.list{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-top:20px;}
.item{border:1px solid #ddd;border-radius:10px;overflow:hidden;transition:transform 0.2s, box-shadow 0.2s;cursor:pointer;background:var(--card-bg);}
.item img{width:100%;height:180px;object-fit:cover;background:#fafafa;}
.item .b{padding:15px;}
.price{color:var(--danger);font-weight:800;font-size:1.3em;margin:8px 0;}

/* é¢„çº¦/è”ç³»æ¨¡å— */
.form label{display:flex;gap:8px;align-items:center;margin:12px 0;}
.form input,.form select,.form textarea{flex:1;border:1px solid var(--border);border-radius:6px;padding:10px;font-size:14px;}
.btn{background:var(--primary);color:#fff;border:none;border-radius:6px;padding:10px 16px;cursor:pointer;transition:.2s;font-weight:600;}
.btn.outline{background:#fff;color:var(--primary);border:1px solid var(--primary);}
.btn.danger{background:var(--danger);}
.btn.ok{background:var(--ok);}
.hr{height:1px;background:var(--border);margin:20px 0;}

/* å¼¹çª—å’Œåå°æ ·å¼ */
.dialog{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;padding:14px;z-index:200;}
.dbox{max-width:550px;width:100%;background:var(--card-bg);border-radius:10px;padding:25px;box-shadow:var(--shadow);}
.admin-wrap{display:none;padding:20px;background:var(--bg);}
.subtabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:15px;padding-bottom:10px;border-bottom:1px solid var(--border);}
.subtab{padding:10px 15px;border:none;border-radius:6px;background:var(--border);cursor:pointer;font-weight:600;color:var(--text);}
.subtab.active{color:#fff;background:var(--primary);}
.panel{margin-top:20px;padding:10px;border-radius:8px;background:var(--card-bg);display:none;}
.panel.active{display:block;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid var(--border);padding:10px;text-align:left;font-size:14px;}
th{background:#f8f9fa;font-weight:700;}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-top:20px;}
.k .n{font-weight:800;color:var(--primary);font-size:24px;}
.admin-actions button{margin-right:5px;margin-bottom:5px;font-size:13px;padding:8px 12px;}

/* ç”µå­åˆåŒé¢„è§ˆæ ·å¼ - é€‚ç”¨äºæ‰“å° */
#contractContent{
    padding: 30px;
    background: #fff;
    border: 1px solid #ddd;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    max-height: 500px;
    overflow-y: auto;
    /* å…è®¸ç¼–è¾‘çš„æ ·å¼æç¤º */
    border: 2px dashed var(--accent); 
    padding: 30px;
}
[contenteditable="true"]#contractContent:focus {
    border-color: var(--ok);
    outline: none;
    background: #f8fff8;
}
#contractContent h2{text-align: center; margin-bottom: 20px;}
#contractContent p{text-indent: 2em;}
#contractContent .term-block{border:1px solid #ddd; padding: 15px; margin: 15px 0;}

/* æ–‡æœ¬ç­¾ååŒºåŸŸæ ·å¼ */
.signature-box{
    width: 180px; 
    height: 75px; 
    border-bottom: 1px solid #333; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 16px; 
    font-weight: bold; 
    color: var(--primary);
    margin-top: 10px;
}

.tenant-actions { margin-top: 15px; display: flex; gap: 10px; }

/* æ‰“å°æ—¶éšè—éåˆåŒå†…å®¹ */
@media print {
    body > .header, body > .wrap:not(#contractModal) {display: none;}
    #contractModal {
        position: static !important;
        display: block !important;
        background: none !important;
        padding: 0;
        width: 100%;
    }
    .dbox {max-width: 100% !important; box-shadow: none !important; padding: 0 !important; margin: 0;}
    .contract-controls {display: none;} /* éšè—ç¼–è¾‘æŒ‰é’® */
    #contractContent {max-height: none; overflow: visible; border: none; box-shadow: none; padding: 0 !important;}
    [contenteditable="true"]#contractContent { border: none !important; }
}
</style>
</head>
<body>

<header class="header">
  <div class="brand">æ²ªä¹é”¦</div>
  <div class="header-right">
    <a class="header-link" id="openUserCenter" href="javascript:void(0)">æˆ‘çš„ç§Ÿçº¦</a>
    <a class="header-link accent" id="openAdmin" href="javascript:void(0)">ç®¡ç†å‘˜å…¥å£</a>
  </div>
</header>

<div class="wrap" id="main-view">
  
  <div id="hero"><h1>ä¼˜é€‰å…¬å¯“ï¼Œä¸“ä¸šæœåŠ¡</h1></div>

  <div class="notice" id="noticeBar">ğŸ“¢ æ¬¢è¿å…¥ä½æ²ªä¹é”¦å…¬å¯“</div>

  <div class="content">

    <nav class="topnav" id="catTabs">
      </nav>
    
    <section class="grid">
      <section>
        <h3>å½“å‰åœ¨ç§Ÿæˆ¿æº (å…± <span id="houseCount">0</span> å¥—)</h3>
        <div class="list" id="listingList">
          </div>
        
        <div id="serviceReservationContainer" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);">
             <div class="card" style="padding: 15px; background: #fff8f2; border-left: 4px solid var(--primary);">
                <h4>å…¬å…±æœåŠ¡é¢„çº¦</h4>
                <p class="muted">è¯·å…ˆ <a href="javascript:void(0)" onclick="showDlg('userCenterDlg')" style="font-weight: bold;">ç™»å½•æˆ‘çš„ç§Ÿçº¦</a>ï¼Œæ–¹å¯é¢„çº¦ KTVã€æ£‹ç‰Œå®¤ç­‰å…¬å…±è®¾æ–½ã€‚</p>
            </div>
        </div>

      </section>

      <section>
        <div class="card" style="border-left:4px solid var(--accent);">
          <h4>ğŸ“… ç«‹å³é¢„çº¦çœ‹æˆ¿</h4>
          <form id="appointmentForm" class="form">
            <label><span>å§“å</span><input name="name" required></label>
            <label><span>æ‰‹æœº</span><input name="phone" required type="tel"></label>
            <label><span>æ„å‘æˆ¿æº</span>
              <select name="house" id="aptHouseSelect" required>
                <option value="">è¯·é€‰æ‹©æ„å‘æˆ¿æº</option>
              </select>
            </label>
            <label><span>çœ‹æˆ¿æ—¥æœŸ</span><input name="time" type="date" required></label>
            <button class="btn" type="submit" style="width:100%;margin-top:10px;">æäº¤é¢„çº¦</button>
          </form>
        </div>

        <div class="hr"></div>
        
        <div class="card" style="text-align:center;">
          <h4>ä¸“å±å®¢æœçƒ­çº¿</h4>
          <p class="muted" style="font-size:1.1em; margin-bottom:10px;">
            ç”µè¯ï¼š<b style="color:var(--primary)">150 2156 0258</b>
          </p>
          <a href="tel:15021560258" class="btn outline" style="width:100%;text-align:center;">ğŸ“ ä¸€é”®è‡´ç”µå®¢æœ</a>
        </div>
      </section>
    </section>
  </div>

  <footer class="footer">
    Â© 2025 æ²ªä¹é”¦å…¬å¯“ç³»ç»Ÿ - æä¾›ä¸“ä¸šã€å¯é çš„ç§Ÿæˆ¿æœåŠ¡
  </footer>
</div>

<div class="dialog" id="loginDlg">
  <div class="dbox">
    <h3>ç®¡ç†å‘˜ç™»å½•</h3>
    <form id="loginForm" class="form">
      <label>è´¦å· <input name="u" required placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜è´¦å·"></label>
      <label>å¯†ç  <input name="p" type="password" required placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç "></label>
      <button class="btn" type="submit">ç™»å½•</button>
      <button class="btn outline" type="button" onclick="hideDlg('loginDlg')">å–æ¶ˆ</button>
      <div class="muted" style="margin-top:10px;">* è¯·è¾“å…¥æ‚¨è®¾ç½®çš„ç®¡ç†å‘˜è´¦å·å’Œå¯†ç </div>
    </form>
  </div>
</div>

<div class="dialog" id="contractModal">
    <div class="dbox" style="max-width:900px; width:95%; padding: 0;">
        <div class="contract-controls" style="padding: 20px; border-bottom: 1px solid var(--border); background: #f8f8f8;">
            <h3 style="margin: 0; display: inline-block;">ğŸ“‘ ç§Ÿæˆ¿åˆåŒæ¨¡æ¿ç¼–è¾‘ä¸ç­¾ç½²</h3>
            <button class="btn ok" onclick="saveContractTemplate()" style="float: right;">ğŸ’¾ ä¿å­˜æ‰€æœ‰ä¿®æ”¹</button>
        </div>

        <div style="display: flex;">
            <div style="flex: 2; padding: 20px; border-right: 1px solid var(--border);">
                <h4 style="margin-top:0;">åˆåŒå†…å®¹ (å¯ç›´æ¥ä¿®æ”¹)</h4>
                <div id="contractContent" contenteditable="true">
                    </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn accent" onclick="promptContractPrint()">ğŸ“„ æ‰“å° / ç”ŸæˆPDF</button>
                    <button class="btn danger" onclick="hideDlg('contractModal')">å…³é—­</button>
                </div>
            </div>

            <div style="flex: 1; padding: 20px; background: var(--bg);">
                <h4>ğŸ“ åˆåŒå…³é”®å­—æ®µ</h4>
                <form id="contractTemplateForm" class="form">
                    <label><span>åˆåŒåç§°</span><input name="name" type="text" required></label>
                    <label><span>æœˆç§Ÿ (Â¥)</span><input name="price" type="number" required></label>
                    <label><span>æŠ¼é‡‘ (Â¥)</span><input name="deposit" type="number" required></label>
                    <label><span>ç‰©ä¸šè´¹</span><input name="mgmtFee" type="text" required></label>
                </form>

                <div class="hr"></div>

                <h4>ğŸ–Šï¸ ç”²æ–¹ï¼ˆæˆ¿ä¸œ/ç®¡ç†å‘˜ï¼‰ç­¾å</h4>
                <p class="muted" style="margin-bottom: 5px;">è¯·è¾“å…¥æˆ¿ä¸œ/ç®¡ç†å‘˜å§“å</p>
                <input type="text" id="signatureTextInput" placeholder="æ‰“å­—è¾“å…¥æˆ¿ä¸œå§“å" style="width:100%; padding: 10px; border: 2px solid var(--accent); border-radius: 6px;">
                <button class="btn ok" onclick="saveTypedSignature()" style="width: 100%; margin-top: 10px;">ç¡®è®¤å¹¶ä¿å­˜æ–‡æœ¬ç­¾å</button>
                <p class="muted" style="font-size: 12px; margin-top: 10px;">* ç”µå­ç­¾åå·²æ”¹ä¸ºæ–‡æœ¬è¾“å…¥æ–¹å¼ã€‚</p>
            </div>
        </div>
    </div>
</div>

<div class="dialog" id="houseModal">
  <div class="dbox" style="max-width:600px;">
    <h3 id="houseModalTitle">ç¼–è¾‘æˆ¿æº</h3>
    <form id="houseForm" class="form">
      <input type="hidden" name="id" id="houseId">
      <label><span>æˆ¿æºåç§°</span><input type="text" name="title" required></label>
      <label><span>æ‰€å±åˆ†ç±»</span>
        <select name="category" required>
          <option value="äº‘é£å…¬å¯“">äº‘é£å…¬å¯“</option><option value="ç™½é©¬å…¬å¯“">ç™½é©¬å…¬å¯“</option>
          <option value="åˆ«å¢…">åˆ«å¢…</option><option value="æ²ªä¹é”¦å…¬å¯“">æ²ªä¹é”¦å…¬å¯“</option>
        </select>
      </label>
      <label><span>æœˆç§Ÿ (Â¥)</span><input type="number" name="price" required></label>
      <label><span>æˆ·å‹</span><input type="text" name="layout" placeholder="å¦‚ï¼š2å®¤1å…" required></label>
      <label><span>å›¾ç‰‡</span><input type="file" name="imgFile" accept="image/*" id="houseImgFile"></label>
      <img id="houseImgPreview" style="display:none;width:100%;height:150px;object-fit:cover;margin:10px 0;border-radius:8px;">
      <div style="display:flex;gap:10px;margin-top:15px;">
        <button type="submit" class="btn ok" style="flex:1">ä¿å­˜/æ–°å¢æˆ¿æº</button>
        <button type="button" class="btn danger" onclick="hideDlg('houseModal')" style="flex:1">å–æ¶ˆ</button>
      </div>
    </form>
  </div>
</div>

<div class="dialog" id="userCenterDlg">
  <div class="dbox">
    <div id="userCenter">
      <h3 style="margin-top:0">æˆ‘çš„ç§Ÿçº¦</h3>
      <form id="userLoginForm" class="form">
        <label>ç”¨æˆ·å/æ‰‹æœºå· <input name="u" required placeholder="è¯·è¾“å…¥æ‚¨çš„å§“åæˆ–æ‰‹æœºå·"></label>
        <label>å¯†ç  <input name="p" type="password" required placeholder="ä»»æ„å¯†ç "></label>
        <button class="btn" type="submit">ç™»å½•ç§Ÿæˆ·ä¸­å¿ƒ</button>
        <button class="btn outline" type="button" onclick="hideDlg('userCenterDlg')">å–æ¶ˆ</button>
        <p class="muted" style="margin-top:10px; text-align:center;">* ä»…é™å·²åœ¨åå°å½•å…¥ä¿¡æ¯çš„ç§Ÿæˆ·ä½¿ç”¨</p>
      </form>
      <div id="rentalInfo" style="display:none">
        <h4>æ¬¢è¿æ‚¨ï¼Œ<span id="tenantName">æŸç§Ÿæˆ·</span>ï¼</h4>
        <div class="rental-info">
          <p>ğŸ  **ç§Ÿçº¦æˆ¿æºï¼š** <span id="infoHouse"></span></p>
          <p>ğŸ’° **æ˜Ÿè±†ä½™é¢ï¼š** <span style="font-weight:bold;color:var(--ok)">120</span> æš</p>
          <p>ğŸ“… **åˆåŒåˆ°æœŸï¼š** <b id="dueDate">2026-06-25</b></p>
          <p>â±ï¸ **å‰©ä½™ç§ŸæœŸï¼š** è¿˜æœ‰ <span class="days-left" id="daysLeft">...</span> å¤©</p>
        </div>
        
        <div class="tenant-actions">
            <button class="btn danger" style="flex:1;" onclick="showDlg('repairModal')">ğŸš¨ æäº¤æŠ¥ä¿®ç”³è¯·</button>
            <button class="btn accent" style="flex:1;" onclick="showMsgModal()">ğŸ’¬ ä¸€é”®ç•™è¨€/è¯„è®º</button>
        </div>
        
        <div id="tenantFacilityReservation">
            </div>

        <div style="display:flex;gap:10px;margin-top:15px;">
          <a href="tel:15021560258" class="btn ok" style="flex:1;text-align:center;">ä¸€é”®è”ç³»å®¢æœ</a>
          <button class="btn" style="flex:1;">ä¸€é”®ç”³è¯·æ¢ç§Ÿ</button>
        </div>
        <button class="btn danger" style="width:100%;margin-top:10px;" onclick="simulateLogout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </div>
</div>

<div class="dialog" id="addTenantModal">
  <div class="dbox" style="max-width:500px;">
    <h3>ğŸ‘¤ æ–°å¢ç§Ÿæˆ·ä¿¡æ¯</h3>
    <form id="addTenantForm" class="form">
      <label><span>å§“å</span><input name="name" required></label>
      <label><span>æ€§åˆ«</span>
        <select name="gender" required>
          <option value="ç”·">ç”·</option>
          <option value="å¥³">å¥³</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
      </label>
      <label><span>æ‰‹æœºå·</span><input name="phone" required type="tel"></label>
      <label><span>èº«ä»½è¯å·</span><input name="idcard" required placeholder="ç”¨äºç§Ÿçº¦ç®¡ç†"></label>
      <label><span>å…¥ä½æˆ¿å‹</span><input name="house" required placeholder="å¦‚ï¼šäº‘é£å…¬å¯“Aæ ‹ä¸€å±…å®¤"></label>
      <label><span>æœˆç§Ÿé‡‘é¢ (Â¥)</span><input name="price" type="number" required></label> <label><span>ç§Ÿçº¦å¼€å§‹</span><input name="start" required type="date"></label>
      <label><span>ç§Ÿçº¦ç»“æŸ</span><input name="end" required type="date"></label>
      <button class="btn ok" type="submit" style="width:100%;margin-top:10px;">ğŸ’¾ ç¡®è®¤å½•å…¥ç§Ÿæˆ·</button>
    </form>
  </div>
</div>

<div class="dialog" id="repairModal">
  <div class="dbox" style="max-width:450px;">
    <h3>ğŸš¨ æäº¤æŠ¥ä¿®ç”³è¯·</h3>
    <form id="repairForm" class="form">
      <label><span>æŠ¥ä¿®æˆ¿æº</span><input name="house" id="repairHouse" readonly></label>
      <label><span>è”ç³»ç”µè¯</span><input name="phone" id="repairPhone" type="tel" readonly></label>
      <label><span>æ•…éšœæè¿°</span>
        <textarea name="description" required rows="4" placeholder="è¯·è¯¦ç»†æè¿°æ•…éšœæƒ…å†µï¼Œå¦‚ï¼šå«ç”Ÿé—´é©¬æ¡¶å µå¡"></textarea>
      </label>
      <button class="btn danger" type="submit" style="width:100%;margin-top:10px;">æäº¤æŠ¥ä¿®</button>
    </form>
  </div>
</div>

<div class="dialog" id="messageModal">
  <div class="dbox" style="max-width:450px;">
    <h3>ğŸ’¬ ç§Ÿå®¢ä¸€é”®ç•™è¨€</h3>
    <form id="messageForm" class="form">
      <label><span>æ‚¨çš„å§“å</span><input name="name" id="msgName" readonly></label>
      <label><span>è”ç³»ç”µè¯</span><input name="phone" id="msgPhone" type="tel" readonly></label>
      <label><span>ç•™è¨€å†…å®¹</span>
        <textarea name="content" required rows="4" placeholder="è¯·ç•™ä¸‹æ‚¨æƒ³å¯¹ç®¡ç†å‘˜è¯´çš„è¯ã€å»ºè®®æˆ–æ„è§"></textarea>
      </label>
      <button class="btn accent" type="submit" style="width:100%;margin-top:10px;">æäº¤ç•™è¨€</button>
    </form>
  </div>
</div>


<div class="wrap admin-wrap" id="adminWrap">
  <div class="content" style="margin-top:0;padding:0;background:var(--bg);">
    <div class="card" style="border:none;box-shadow:none;">
      <div class="header" style="color:#333;background:var(--card-bg);border-radius:12px;box-shadow:var(--shadow);">
        <div class="brand" style="color:#333">ğŸ› ï¸ åå°ç®¡ç†ç³»ç»Ÿ</div>
        <a class="header-link" href="#" id="backFront">â† è¿”å›å‰å°</a>
      </div>

      <div class="kpis">
        <div class="k"><div>åœ¨ç§Ÿæˆ¿æº</div><div class="n" id="kpiListings">0</div></div>
        <div class="k"><div>åˆåŒæ€»æ•°</div><div class="n" id="kpiContracts">0</div></div>
        <div class="k" style="border-left-color:var(--accent);"><div>å¾…å¤„ç†è®¢å•</div><div class="n" id="kpiOrders" style="color:var(--accent);">0</div></div>
        <div class="k" style="border-left-color:var(--ok);"><div>æ€»ç§Ÿæˆ·æ•°</div><div class="n" id="kpiTenants" style="color:var(--ok);">0</div></div>
      </div>

      <div class="subtabs" id="adminTabs">
        <button class="subtab active" data-p="pListings">æˆ¿æºç®¡ç†</button>
        <button class="subtab" data-p="pContracts">åˆåŒç®¡ç†</button>
        <button class="subtab" data-p="pOrders">æœåŠ¡è®¢å• & ç•™è¨€</button>
        <button class="subtab" data-p="pTenants">ç§Ÿæˆ·ä¸­å¿ƒ & æ˜Ÿè±†</button>
        <button class="subtab" data-p="pAnn">å…¬å‘Šé…ç½®</button>
        <button class="subtab" data-p="pStats">æ•°æ®ç»Ÿè®¡</button>
      </div>

      <div class="panel active" id="pListings">
        <h3>æˆ¿æºåˆ—è¡¨ (åœ¨ç§Ÿ/å·²ç§Ÿ)</h3>
        <button class="btn ok" onclick="showHouseModal('add')">â• æ–°å¢æˆ¿æºå½•å…¥</button>
        <div class="table" id="tblListings"></div>
      </div>

      <div class="panel" id="pContracts">
        <h3>ç”µå­åˆåŒç®¡ç†ä¸­å¿ƒ</h3>
        <button class="btn accent" onclick="openContractModal()">ğŸ“‘ ç¼–è¾‘åˆåŒæ¨¡æ¿ä¸é¢„è§ˆ</button>
        <div class="table" id="tblContracts"></div>
        <div class="hr"></div>
        <h4>ç”Ÿæˆæ–°åˆåŒ</h4>
        <form id="contractForm" class="form">
          <label>ç§Ÿå®¢å§“å <input name="name" required></label>
          <label>èº«ä»½è¯å· <input name="idcard" required></label>
          <label>æˆ¿æº <input name="house" required placeholder="å¦‚ï¼šäº‘é£å…¬å¯“ 1201"></label>
          <label>èµ·æ­¢æ—¥æœŸ <input name="period" required placeholder="2025-05-01 ~ 2026-04-30"></label>
          <button class="btn" type="submit">ç”Ÿæˆå¹¶é¢„è§ˆåˆåŒ</button>
        </form>
      </div>

      <div class="panel" id="pOrders">
        <h3>å¾…å¤„ç†è®¢å• (é¢„çº¦çœ‹æˆ¿ & æœåŠ¡ & ç»´ä¿®)</h3>
        <div class="table" id="tblOrders"></div>
        <button class="btn" style="margin-top:15px;" onclick="alert('ç‚¹å‡»æœåŠ¡è®¢å•åï¼Œå¯è¿›è¡ŒæŠ¢å•/æ´¾å•æ“ä½œ')">è¿›å…¥æŠ¢å•ä¸­å¿ƒ (æ¨¡æ‹Ÿ)</button>
        
        <div class="hr"></div>
        <h4>ğŸ’¬ ç§Ÿå®¢ç•™è¨€ (ç‚¹å‡»â€œå·²è¯»â€åç§»é™¤)</h4>
        <div class="table" id="tblMessages"></div>
      </div>

      <div class="panel" id="pTenants">
        <h3>ç§Ÿæˆ·ä¿¡æ¯ç®¡ç†</h3>
        <button class="btn ok" onclick="showDlg('addTenantModal')">â• æ–°å¢ç§Ÿæˆ·å½•å…¥</button>
        
        <h4 style="margin-top:20px;">å½“å‰ç§Ÿæˆ·åˆ—è¡¨ & æ˜Ÿè±†ä½™é¢ (å…± <span id="tenantCount">0</span> å)</h4>
        <div class="table" id="tblTenants"></div>
      </div>
      
      <div class="panel" id="pAnn">
        <h3>ä¿®æ”¹ç½‘ç«™å…¬å‘Š</h3>
        <form id="annForm" class="form">
          <label>å…¬å‘Šæ–‡æ¡ˆ <input name="txt" id="annInput" required placeholder="æ¬¢è¿å…¥ä½æ²ªä¹é”¦å…¬å¯“"></label>
          <button class="btn" type="submit">ä¿å­˜å…¬å‘Š</button>
        </form>
      </div>

      <div class="panel" id="pStats">
        <h3>æ•°æ®ç»Ÿè®¡ä¸­å¿ƒ</h3>
        <p class="muted">æ­¤å¤„ä¸ºé™æ€æ¨¡æ‹Ÿå›¾è¡¨ï¼Œå¦‚éœ€å®é™…æ•°æ®ç»Ÿè®¡ï¼Œéœ€åç«¯æ”¯æŒã€‚</p>
      </div>
    </div>
  </div>
</div>

<script>
/******** æ•°æ®å±‚ï¼ˆlocalStorageï¼‰ ********/
const LS={get(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},set(k,v){localStorage.setItem(k,JSON.stringify(v))},del(k){localStorage.removeItem(k)}};
const DB={listings:'hj_listings',tenants:'hj_tenants',orders:'hj_orders',contracts:'hj_contracts',ann:'hj_announce', contractTpl: 'hj_contract_template', signature: 'hj_signature_text'}; // signature key changed
// ä»…ç”¨äºå†…éƒ¨æ ¡éªŒï¼Œä¸å†å¯¹å¤–æ˜¾ç¤º
const ADMIN_ACCOUNTS=['15316990186','15021560258','13651780099','13917439578','15002168467','15651100141'];
const ADMIN_PASSWORD='125811234';
const CATEGORIES = ['äº‘é£å…¬å¯“', 'ç™½é©¬å…¬å¯“', 'åˆ«å¢…', 'æ²ªä¹é”¦å…¬å¯“'];
const CUSTOMER_SERVICE = '150 2156 0258';
let LOGGED_IN_TENANT = null; 

function uid(){return Math.random().toString(36).slice(2,9)}
function fileToDataURL(file) {
    return new Promise(r => {
        const fr = new FileReader();
        fr.onload = () => r(fr.result);
        fr.readAsDataURL(file);
    });
}
function getDefaultContractTemplate() {
    return LS.get(DB.contractTpl) || {
        name: "ã€æ²ªä¹é”¦å…¬å¯“ã€‘æ ‡å‡†ç§Ÿæˆ¿åˆåŒ",
        price: 3500,
        deposit: 7000,
        mgmtFee: "å·²åŒ…å«åœ¨ç§Ÿé‡‘å†…",
        content: `
            <h2>ã€æ²ªä¹é”¦å…¬å¯“ã€‘æ ‡å‡†ç§Ÿæˆ¿åˆåŒ</h2>
            <p>åˆåŒç¼–å·ï¼š{"{{contractNo}}"}ã€‚ç”²æ–¹ï¼ˆå‡ºç§Ÿæ–¹ï¼‰ï¼šæ²ªä¹é”¦å…¬å¯“ç®¡ç†å¤„</p>
            <p>ä¹™æ–¹ï¼ˆæ‰¿ç§Ÿæ–¹ï¼‰ï¼š{"{{tenantName}}"}ï¼Œèº«ä»½è¯å·ï¼š{"{{tenantIdcard}}"}</p>
            <p>ç»ç”²ä¹™åŒæ–¹åå•†ä¸€è‡´ï¼Œç­¾è®¢æœ¬åˆåŒï¼Œç§Ÿèµä»¥ä¸‹æˆ¿å±‹ï¼š</p>
            
            <div class="term-block">
                <h4>ç¬¬ä¸€æ¡ æˆ¿å±‹ä¿¡æ¯ä¸ç§ŸæœŸ</h4>
                <p>1.1 æˆ¿å±‹åœ°å€ï¼š{"{{house}}"}ï¼Œç§ŸæœŸï¼š{"{{period}}"}ã€‚è‡ª {"{{startDate}}"} è‡³ {"{{endDate}}"}ã€‚</p>
                <p>1.2 åˆåŒåç§°ï¼š{"{{name}}"}</p>
            </div>
            
            <div class="term-block">
                <h4>ç¬¬äºŒæ¡ ç§Ÿé‡‘åŠè´¹ç”¨</h4>
                <p>2.1 æˆ¿å±‹æœˆç§Ÿé‡‘ä¸ºäººæ°‘å¸ï¼šÂ¥{"{{price}}"}å…ƒæ•´ã€‚æŠ¼é‡‘ä¸º Â¥{"{{deposit}}"}å…ƒæ•´ã€‚</p>
                <p>2.2 ç‰©ä¸šç®¡ç†è´¹ï¼š{"{{mgmtFee}}"}ã€‚æ°´ç”µç…¤è´¹ç”¨ç”±ä¹™æ–¹æ‰¿æ‹…ã€‚</p>
            </div>
            
            <div class="term-block">
                <h4>ç¬¬ä¸‰æ¡ ç­¾åç”Ÿæ•ˆ</h4>
                <p>åˆåŒä¸€å¼ä¸¤ä»½ï¼Œç”²ä¹™åŒæ–¹å„æ‰§ä¸€ä»½ï¼Œè‡ªåŒæ–¹ç­¾å­—ç›–ç« ä¹‹æ—¥èµ·ç”Ÿæ•ˆã€‚</p>
            </div>
            
            <div style="margin-top: 50px; display: flex; justify-content: space-between;">
                <div style="width: 45%;">
                    <p><b>ç”²æ–¹ï¼ˆæˆ¿ä¸œï¼‰ç­¾å­—ï¼š</b></p>
                    <div class="signature-box" id="contractSignatureA">{{signature}}</div>
                    <p>æ—¥æœŸï¼š{"{{currentDate}}"}</p>
                </div>
                <div style="width: 45%;">
                    <p><b>ä¹™æ–¹ï¼ˆç§Ÿæˆ·ï¼‰ç­¾å­—ï¼š</b></p>
                    <div style="width: 180px; height: 75px; border-bottom: 1px solid #333; display: inline-block;"></div>
                    <p>æ—¥æœŸï¼š{"{{currentDate}}"}</p>
                </div>
            </div>
        `
    };
}


function initOnce(){
  if(!LS.get(DB.listings)){
    LS.set(DB.listings,[
      {id:uid(),title:"äº‘é£å…¬å¯“Aæ ‹ä¸€å±…å®¤",category:"äº‘é£å…¬å¯“",price:3500,layout:"1å®¤1å…",img:ph(1),status:'available'},
      {id:uid(),title:"ç™½é©¬å…¬å¯“Bæ ‹å•é—´",category:"ç™½é©¬å…¬å¯“",price:1800,layout:"1å®¤",img:ph(2),status:'available'},
      {id:uid(),title:"åˆ«å¢…CåŒºè±ªåæˆ¿",category:"åˆ«å¢…",price:9800,layout:"5å®¤3å…",img:ph(3),status:'available'},
      {id:uid(),title:"æ²ªä¹é”¦Dæ ‹ä¸¤å±…å®¤",category:"æ²ªä¹é”¦å…¬å¯“",price:4200,layout:"2å®¤1å…",img:ph(4),status:'rented'}, 
    ]);
  }
  if(!LS.get(DB.tenants))LS.set(DB.tenants,[
    // ç§Ÿæˆ·æ•°æ®å¢åŠ  price å­—æ®µ
    {id:'T1',user:'å¼ ä¸‰',gender:'ç”·',phone:'13800001111',house:'äº‘é£å…¬å¯“Aæ ‹ä¸€å±…å®¤',price:3500,idcard:'310xxxxxxxxxx001',start:'2025-01-01',end:'2026-01-01',stars:120,ts:Date.now()},
    {id:'T2',user:'æå››',gender:'å¥³',phone:'13900002222',house:'ç™½é©¬å…¬å¯“Bæ ‹å•é—´',price:1800,idcard:'310xxxxxxxxxx002',start:'2024-10-15',end:'2025-10-14',stars:250,ts:Date.now()}
  ]);
  if(!LS.get(DB.orders))LS.set(DB.orders,[
    {id:'O1',type:'é¢„çº¦çœ‹æˆ¿',name:'ç‹äº”',phone:'150xxxx1234',house:'äº‘é£å…¬å¯“Aæ ‹',time:'2025-10-25',content:'çœ‹æˆ¿',status:'å¾…è”ç³»',ts:Date.now()},
    {id:'O2',type:'ç§Ÿå®¢ç•™è¨€',name:'æå››',phone:'13900002222',house:'ç™½é©¬å…¬å¯“Bæ ‹å•é—´',content:'å¸Œæœ›å…¬å¯“èƒ½å¢åŠ ä¸€ä¸ªå¥èº«æˆ¿ï¼',status:'å¾…å¤„ç†',ts:Date.now()-86400000}
  ]);
  if(!LS.get(DB.contracts))LS.set(DB.contracts,[
    {id:'C1',no:'HT20240423001',name:'ç‹äº”',idcard:'310xxxxxx4567',house:'äº‘é£å…¬å¯“ 0304',period:'2025-05-01 ~ 2026-04-30',ts:Date.now()}
  ]);
  if(!LS.get(DB.ann))LS.set(DB.ann,"æ¬¢è¿å…¥ä½æ²ªä¹é”¦å…¬å¯“ï¼Œå®¢æœç”µè¯ï¼š"+CUSTOMER_SERVICE);
  if(!LS.get(DB.contractTpl))LS.set(DB.contractTpl, getDefaultContractTemplate());
  if(!LS.get(DB.signature))LS.set(DB.signature, 'æˆ¿ä¸œ/ç®¡ç†å‘˜'); // é»˜è®¤æ–‡æœ¬ç­¾å
}
initOnce();

/******** è¾…åŠ©å‡½æ•° ********/
function byId(id){return document.getElementById(id)}
function ph(seed=1){return 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400"><rect width="100%" height="100%" fill="#fff5ec"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#ff7f32" font-size="30">æˆ¿æºå›¾ç‰‡${seed}</text></svg>`)}
function table(sel,heads,rows){
  const h="<tr>"+heads.map(x=>`<th>${x}</th>`).join("")+"</tr>";
  const r=(rows||[]).map(row=>"<tr>"+row.map(c=>`<td>${c}</td>`).join("")+"</tr>").join("");
  byId(sel).innerHTML=`<table><thead>${h}</thead><tbody>${r||`<tr><td colspan="${heads.length}">æš‚æ— æ•°æ®</td></tr>`}</tbody></table>`;
}
function showDlg(id){byId(id).style.display='flex'}
function hideDlg(id){byId(id).style.display='none'}
function initAdminTabs() {
    document.querySelectorAll('#adminTabs .subtab').forEach(btn=>{
      btn.onclick=()=>{
        document.querySelectorAll('#adminTabs .subtab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('#adminWrap .panel').forEach(p=>p.classList.remove('active'));
        document.getElementById(btn.dataset.p).classList.add('active');
        paintAdmin(); 
      };
    });
}
initAdminTabs();

// NEW: æ ‡è®°è®¢å•/ç•™è¨€å®Œæˆå¹¶ç§»é™¤
function markOrderAsCompleted(id) {
    let orders = LS.get(DB.orders, []);
    const order = orders.find(x => x.id === id);
    if (!order) return;

    if (confirm(`ç¡®å®šè¦å°†ã€${order.type === 'ç§Ÿå®¢ç•™è¨€' ? 'ç•™è¨€' : 'è®¢å•'}ï¼š${order.name} - ${order.content || order.house}ã€‘æ ‡è®°å®Œæˆå¹¶ä»åˆ—è¡¨ä¸­ç§»é™¤å—ï¼Ÿ`)) {
        const updatedOrders = orders.filter(x => x.id !== id);
        LS.set(DB.orders, updatedOrders);
        alert(`ã€${order.type}ã€‘å·²æ ‡è®°å®Œæˆå¹¶ç§»é™¤ã€‚`);
        paintAdmin();
    }
}

// NEW: åˆ é™¤åˆåŒ
function deleteContract(id) {
    if (!confirm('ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ä»½åˆåŒå—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚')) return;
    let contracts = LS.get(DB.contracts, []);
    const updatedContracts = contracts.filter(c => c.id !== id);
    LS.set(DB.contracts, updatedContracts);
    alert('åˆåŒå·²åˆ é™¤ã€‚');
    paintAdmin();
}


/******** ç”µå­åˆåŒä¸ç­¾åé€»è¾‘ (å·²æ”¹ä¸ºæ–‡æœ¬è¾“å…¥) ********/

let signatureText = LS.get(DB.signature, 'æˆ¿ä¸œ/ç®¡ç†å‘˜');

// ç¡®è®¤ç­¾åï¼Œä¿å­˜ä¸ºDataURL
window.saveTypedSignature = function() {
    const text = byId('signatureTextInput').value.trim();
    if (!text) {
        return alert('è¯·è¾“å…¥æˆ¿ä¸œ/ç®¡ç†å‘˜çš„å§“åã€‚');
    }
    signatureText = text;
    LS.set(DB.signature, signatureText);
    renderContractPreview();
    alert('æˆ¿ä¸œæ–‡æœ¬ç­¾åå·²ä¿å­˜ï¼');
};


// æ›¿æ¢åˆåŒæ¨¡æ¿ä¸­çš„å ä½ç¬¦
function renderContractContent(data) {
    const tpl = LS.get(DB.contractTpl);
    let content = tpl.content;
    const today = new Date().toLocaleDateString('zh-CN', {year: 'numeric', month: 'long', day: 'numeric'});
    const sigText = LS.get(DB.signature) || '_______';

    // æ›¿æ¢åŠ¨æ€æ•°æ®
    content = content.replace(/\{\{name\}\}/g, tpl.name)
                     .replace(/\{\{contractNo\}\}/g, data.no || 'HT-PREVIEW-001')
                     .replace(/\{\{price\}\}/g, data.price)
                     .replace(/\{\{deposit\}\}/g, tpl.deposit)
                     .replace(/\{\{mgmtFee\}\}/g, tpl.mgmtFee)
                     .replace(/\{\{house\}\}/g, data.house)
                     .replace(/\{\{tenantName\}\}/g, data.name)
                     .replace(/\{\{tenantIdcard\}\}/g, data.idcard)
                     .replace(/\{\{period\}\}/g, data.period)
                     .replace(/\{\{startDate\}\}/g, data.period.split(' ~ ')[0] || 'å¾…å®š')
                     .replace(/\{\{endDate\}\}/g, data.period.split(' ~ ')[1] || 'å¾…å®š')
                     .replace(/\{\{currentDate\}\}/g, today);
    
    // æ›¿æ¢ç­¾åæ–‡æœ¬
    content = content.replace('{{signature}}', sigText);


    byId('contractContent').innerHTML = content;
}

// ä»…ç”¨äºç¼–è¾‘æ¨¡æ¿æ—¶çš„é¢„è§ˆ
function renderContractPreview() {
    const tpl = getDefaultContractTemplate();
    const mockData = {
        name: 'å¼ ä¸‰ (é¢„è§ˆ)',
        idcard: '310xxxxxx0001',
        house: 'äº‘é£å…¬å¯“Aæ ‹ä¸€å±…å®¤ (é¢„è§ˆæˆ¿æº)',
        period: '2025-05-01 ~ 2026-04-30',
        price: tpl.price
    };
    renderContractContent(mockData);
    
    // å¡«å……æ¨¡æ¿ç¼–è¾‘è¡¨å•
    if(byId('contractTemplateForm')) {
        byId('contractTemplateForm').name.value = tpl.name;
        byId('contractTemplateForm').price.value = tpl.price;
        byId('contractTemplateForm').deposit.value = tpl.deposit;
        byId('contractTemplateForm').mgmtFee.value = tpl.mgmtFee;
    }
    // å¡«å……ç­¾åæ–‡æœ¬è¾“å…¥æ¡†
    byId('signatureTextInput').value = LS.get(DB.signature) || 'æˆ¿ä¸œ/ç®¡ç†å‘˜';
}

// æ‰“å¼€åˆåŒç¼–è¾‘å¼¹çª—
function openContractModal(data = null) {
    renderContractPreview();
    showDlg('contractModal');
}

// ä¿å­˜åˆåŒæ¨¡æ¿ä¿®æ”¹
function saveContractTemplate() {
    const form = byId('contractTemplateForm');
    const newContent = byId('contractContent').innerHTML;
    
    const newTpl = {
        name: form.name.value,
        price: parseFloat(form.price.value),
        deposit: parseFloat(form.deposit.value),
        mgmtFee: form.mgmtFee.value,
        content: newContent // ä¿å­˜å¯ç¼–è¾‘åŒºåŸŸçš„å…¨éƒ¨HTMLå†…å®¹
    };
    LS.set(DB.contractTpl, newTpl);
    // ç¡®ä¿æ–‡æœ¬ç­¾åä¹Ÿè¢«ä¿å­˜
    saveTypedSignature(); 
    renderContractPreview(); 
    alert('åˆåŒæ¨¡æ¿å·²ä¿å­˜ï¼åˆåŒå†…å®¹ã€å…³é”®å­—æ®µå’Œç”²æ–¹ç­¾åå·²æ›´æ–°ã€‚');
}

// è§¦å‘æ‰“å°/PDFç”Ÿæˆ
function promptContractPrint() {
    alert('è¯·ä½¿ç”¨æµè§ˆå™¨å¼¹å‡ºçš„â€œæ‰“å°â€åŠŸèƒ½ï¼Œå¹¶å°†ç›®æ ‡æ‰“å°æœºé€‰æ‹©ä¸ºâ€œå¦å­˜ä¸º PDFâ€æ¥ç”Ÿæˆç”µå­åˆåŒæ–‡ä»¶ã€‚');
    window.print();
}

/******** åå°åˆåŒç”Ÿæˆ ********/
byId('contractForm').addEventListener('submit',e=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  const contractNo = "HT"+Date.now();
  const data = {
    no: contractNo,
    name: fd.get('name'),
    idcard: fd.get('idcard'),
    house: fd.get('house'),
    period: fd.get('period'),
    price: LS.get(DB.contractTpl).price 
  };

  const arr=LS.get(DB.contracts,[]);
  arr.unshift({id:uid(),...data,ts:Date.now()});
  LS.set(DB.contracts,arr); 
  
  e.target.reset(); 
  paintAdmin(); 
  
  // é¢„è§ˆç”Ÿæˆçš„åˆåŒ
  renderContractContent(data);
  alert(`åˆåŒ ${contractNo} å·²ç”Ÿæˆå¹¶å½•å…¥ã€‚å³å°†æ‰“å¼€é¢„è§ˆï¼Œè¯·ç‚¹å‡»ã€æ‰“å°/ç”ŸæˆPDFã€‘æŒ‰é’®ä¿å­˜ã€‚`);
  showDlg('contractModal');
});

/******** æˆ¿æºç®¡ç† (æ–°å¢å’Œç¼–è¾‘) ********/
async function showHouseModal(mode, id = null) {
    const modal = byId('houseModal');
    const form = byId('houseForm');
    form.reset();
    byId('houseImgPreview').style.display = 'none';
    byId('houseId').value = '';

    if (mode === 'add') {
        byId('houseModalTitle').textContent = `æ–°å¢æˆ¿æº`;
        form.querySelector('button[type="submit"]').textContent = 'â• æ–°å¢æˆ¿æº';
        showDlg('houseModal');
    } else if (mode === 'edit' && id) {
        const house = LS.get(DB.listings, []).find(h => h.id === id);
        if (!house) {
            alert('æœªæ‰¾åˆ°è¯¥æˆ¿æºä¿¡æ¯ã€‚');
            return;
        }
        byId('houseModalTitle').textContent = `ç¼–è¾‘æˆ¿æº: ${house.title}`;
        form.querySelector('button[type="submit"]').textContent = 'ä¿å­˜ä¿®æ”¹';
        
        // Populate Form
        byId('houseId').value = house.id;
        form.title.value = house.title;
        form.category.value = house.category;
        form.price.value = house.price;
        form.layout.value = house.layout;
        if (house.img) {
            byId('houseImgPreview').src = house.img;
            byId('houseImgPreview').style.display = 'block';
        }
        showDlg('houseModal');
    }
}
byId('houseForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    let allHouses = LS.get(DB.listings, []);
    const houseId = fd.get('id');
    
    let imgDataURL = byId('houseImgPreview').src.startsWith('data:') ? byId('houseImgPreview').src : ph(1); 
    if (fd.get('imgFile').size > 0) {
        imgDataURL = await fileToDataURL(fd.get('imgFile'));
    }

    if (houseId) {
        // ç¼–è¾‘æ¨¡å¼
        const houseIndex = allHouses.findIndex(h => h.id === houseId);
        if (houseIndex !== -1) {
            allHouses[houseIndex].title = fd.get('title');
            allHouses[houseIndex].category = fd.get('category');
            allHouses[houseIndex].price = parseFloat(fd.get('price'));
            allHouses[houseIndex].layout = fd.get('layout');
            allHouses[houseIndex].img = imgDataURL;
            alert(`æˆ¿æº ${allHouses[houseIndex].title} å·²æ›´æ–°!`);
        }
    } else {
        // æ–°å¢æ¨¡å¼
        const newHouse = {
            id: uid(),
            title: fd.get('title'),
            category: fd.get('category'),
            price: parseFloat(fd.get('price')),
            layout: fd.get('layout'),
            img: imgDataURL,
            status: 'available'
        };
        allHouses.unshift(newHouse);
        alert(`æˆ¿æº ${newHouse.title} æ–°å¢æˆåŠŸ!`);
    }
    
    LS.set(DB.listings, allHouses);
    hideDlg('houseModal');
    paintAdmin();
    renderListing();
});


/******** åå°æ¸²æŸ“ ********/
function paintAdmin(){
  const listings=LS.get(DB.listings,[]);
  const tenants=LS.get(DB.tenants,[]);
  const orders=LS.get(DB.orders,[]);
  const contracts=LS.get(DB.contracts,[]);

  // 1. KPI
  byId('kpiListings').textContent=listings.filter(x=>x.status==='available').length;
  byId('kpiContracts').textContent=contracts.length;
  byId('kpiOrders').textContent=orders.filter(x=>x.status==='å¾…å¤„ç†' || x.status==='å¾…è”ç³»').length;
  byId('kpiTenants').textContent=tenants.length;
  byId('tenantCount').textContent=tenants.length; 

  // 2. æˆ¿æºç®¡ç†
  table('tblListings',["ID","æ ‡é¢˜","åˆ†ç±»","æœˆç§Ÿ","çŠ¶æ€","æ“ä½œ"], 
    listings.map(x=>[
        x.id, x.title, x.category, `ï¿¥${x.price}`, 
        x.status === 'available' ? `<span style="color:${x.status === 'available' ? '#24b36b' : '#e74c3c'}">ç©ºç½®/å¯ç§Ÿ</span>` : `<span style="color:#e74c3c">å·²å‡ºç§Ÿ</span>`,
        `<div class="admin-actions">
            <button class="btn outline" onclick="showHouseModal('edit','${x.id}')">ç¼–è¾‘</button> 
            <button class="btn ${x.status === 'available' ? 'danger' : 'ok'}" onclick="toggleHouseStatus('${x.id}')">${x.status === 'available' ? 'æ ‡è®°å·²å‡ºç§Ÿ' : 'æ ‡è®°å¯ç§Ÿ'}</button>
        </div>`
    ])
  );

  // 3. åˆåŒç®¡ç†
  table('tblContracts',["åˆåŒç¼–å·","ç§Ÿå®¢","èº«ä»½è¯å·","æˆ¿æº","æœŸé—´","æ“ä½œ"], 
    contracts.map(c=>[c.no,c.name,c.idcard,c.house,c.period,
      `<div class="admin-actions">
          <button class="btn outline" onclick="renderContractContent({no:'${c.no}', name:'${c.name}', idcard:'${c.idcard}', house:'${c.house}', period:'${c.period}', price:'${LS.get(DB.contractTpl).price}'}); showDlg('contractModal');">é¢„è§ˆ/PDF</button>
          <button class="btn danger" onclick="deleteContract('${c.id}')">åˆ é™¤</button>
      </div>`
    ])
  );

  // 4. æœåŠ¡è®¢å• (é¢„çº¦/æŠ¥ä¿®/æœåŠ¡é¢„çº¦)
  const serviceOrders = orders.filter(x => x.type !== 'ç§Ÿå®¢ç•™è¨€');
  table('tblOrders',["ç±»å‹","å§“å","æ‰‹æœº","æˆ¿æº/å†…å®¹","æ—¶é—´","çŠ¶æ€","æ“ä½œ"], 
    serviceOrders.map(x=>[
        x.type,x.name,x.phone||'N/A',x.content||x.house,x.time||new Date(x.ts).toLocaleDateString(),
        `<span style="color:${x.status==='å¾…å¤„ç†' || x.status==='å¾…è”ç³»' ? '#e74c3c' : '#24b36b'}">${x.status}</span>`,
        `<button class="btn" onclick="markOrderAsCompleted('${x.id}')">å¤„ç†/å®Œæˆ (ç§»é™¤)</button>` 
    ])
  );
  
  // 4.1 ç§Ÿå®¢ç•™è¨€ (æ–°å¢ç‹¬ç«‹åˆ—è¡¨)
  const tenantMessages = orders.filter(x => x.type === 'ç§Ÿå®¢ç•™è¨€');
  table('tblMessages',["å§“å","æˆ¿æº","å†…å®¹","æ—¶é—´","æ“ä½œ"], 
    tenantMessages.map(x=>[
        x.name,x.house,x.content,new Date(x.ts).toLocaleString(),
        `<button class="btn accent" onclick="markOrderAsCompleted('${x.id}')">æ ‡è®°å·²è¯» (ç§»é™¤)</button>` 
    ])
  );

  // 5. ç§Ÿæˆ·ä¸­å¿ƒ & æ˜Ÿè±† (å·²æ›´æ–°ä¸ºç”¨æˆ·è¯·æ±‚çš„å­—æ®µ)
  table('tblTenants',
    ["åå­—","æ€§åˆ«","èº«ä»½è¯å·ç ","å…¥ä½æˆ¿å‹","æœˆç§Ÿé‡‘é¢ (Â¥)","å…¥ä½æ—¶é—´","æ˜Ÿè±†","æ“ä½œ"], 
    tenants.map(x=>[
        x.user,
        x.gender,
        x.idcard.slice(0, 6) + '******' + x.idcard.slice(-4), // èº«ä»½è¯å·ç 
        x.house, // å…¥ä½æˆ¿å‹
        `Â¥${x.price || 'N/A'}`, // æœˆç§Ÿé‡‘é¢
        x.start, // å…¥ä½æ—¶é—´
        `${x.stars} æš`,
        `<button class="btn outline" onclick="alert('ç»™ ${x.user} ç»­ç§Ÿ/é€€ç§Ÿ')">ç»­ç§Ÿ/é€€ç§Ÿ</button>`
    ])
  );

  // 6. å…¬å‘Š
  byId('annInput').value = LS.get(DB.ann);
}


/******** ç§Ÿæˆ·ä¸­å¿ƒåŠŸèƒ½é€»è¾‘ ********/
function updateTenantUI() {
    const isLogged = !!LOGGED_IN_TENANT;
    byId('openUserCenter').textContent = isLogged ? `æˆ‘çš„ç§Ÿçº¦ (${LOGGED_IN_TENANT.user})` : 'æˆ‘çš„ç§Ÿçº¦';
    const facilityContainer = byId('tenantFacilityReservation');
    const services = [{ name: 'KTV åŒ…å¢', icon: 'ğŸ¤' }, { name: 'æ£‹ç‰Œå®¤', icon: 'ğŸ€„' }, { name: 'å°çƒå®¤', icon: 'ğŸ±' }];
    
    if (isLogged) {
        facilityContainer.innerHTML = `
            <div class="card" style="margin-top: 15px; border-left: 4px solid var(--ok);">
                <h4>ğŸ“… å…¬å…±è®¾æ–½é¢„çº¦ (ç§Ÿæˆ·ä¸“å±)</h4>
                <form id="serviceReservationForm" class="form">
                    <label><span>æœåŠ¡é¡¹ç›®</span><select name="service" required>${services.map(s => `<option value="${s.name}">${s.icon} ${s.name}</option>`).join('')}</select></label>
                    <label><span>é¢„çº¦æ—¥æœŸ</span><input name="date" type="date" required></label>
                    <label><span>é¢„çº¦æ—¶æ®µ</span><input name="time" type="time" required placeholder="å¦‚ 19:00"></label>
                    <button class="btn ok" type="submit" style="width:100%;margin-top:10px;">æäº¤é¢„çº¦ç”³è¯·</button>
                </form>
            </div>
        `;
        byId('serviceReservationForm').addEventListener('submit', handleServiceReservation);
    } else {
        facilityContainer.innerHTML = '';
    }
}
function handleServiceReservation(e) {
    e.preventDefault();
    if (!LOGGED_IN_TENANT) return alert('æœªç™»å½•ç§Ÿæˆ·ä¸­å¿ƒï¼');
    const fd = new FormData(e.target);
    const orders = LS.get(DB.orders,[]);
    orders.unshift({id: uid(),type: 'æœåŠ¡é¢„çº¦',name: LOGGED_IN_TENANT.user,phone: LOGGED_IN_TENANT.phone,house: LOGGED_IN_TENANT.house,time: `${fd.get('date')} ${fd.get('time')}`,content: `é¢„çº¦ ${fd.get('service')}`,status: 'å¾…å¤„ç†',ts: Date.now()});
    LS.set(DB.orders, orders);
    e.target.reset();
    alert(`ã€${fd.get('service')}ã€‘é¢„çº¦å·²æäº¤ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜ç¡®è®¤ï¼`);
}
function showUserRentalInfo(tenant) {
    hideDlg('userCenterDlg');
    showDlg('userCenterDlg');
    byId('userLoginForm').style.display='none';
    byId('rentalInfo').style.display='block';
    byId('tenantName').textContent = tenant.user;
    byId('infoHouse').textContent = tenant.house;
    const dueDate = new Date(tenant.end); 
    const now = new Date();
    const diffTime = dueDate - now;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    byId('daysLeft').textContent = diffDays > 0 ? diffDays : 'å·²åˆ°æœŸ';
    byId('repairHouse').value = tenant.house;
    byId('repairPhone').value = tenant.phone;
    updateTenantUI(); // åˆ·æ–°è®¾æ–½å’Œç•™è¨€æŒ‰é’®
}
function simulateLogout(){
    LOGGED_IN_TENANT = null;
    byId('rentalInfo').style.display='none';
    byId('userLoginForm').style.display='block';
    updateTenantUI();
}

// æŠ¥ä¿®ç”³è¯·æäº¤ (ç•¥)
byId('repairForm').addEventListener('submit', e => {
    e.preventDefault();
    if (!LOGGED_IN_TENANT) return;
    const fd = new FormData(e.target);
    const orders = LS.get(DB.orders,[]);
    orders.unshift({id: uid(),type: 'æŠ¥ä¿®è¯·æ±‚',name: LOGGED_IN_TENANT.user,phone: LOGGED_IN_TENANT.phone,house: LOGGED_IN_TENANT.house,time: new Date().toLocaleString(),content: fd.get('description'),status: 'å¾…å¤„ç†',ts: Date.now()});
    LS.set(DB.orders, orders);
    e.target.reset();
    hideDlg('repairModal');
    alert('æŠ¥ä¿®ç”³è¯·å·²æäº¤ï¼Œç»´ä¿®äººå‘˜å°†å°½å¿«è”ç³»æ‚¨ï¼');
});

// ä¸€é”®ç•™è¨€åŠŸèƒ½ (æ–°å¢)
function showMsgModal() {
    if (!LOGGED_IN_TENANT) return alert('è¯·å…ˆç™»å½•ç§Ÿæˆ·ä¸­å¿ƒï¼');
    byId('msgName').value = LOGGED_IN_TENANT.user;
    byId('msgPhone').value = LOGGED_IN_TENANT.phone;
    showDlg('messageModal');
}
byId('messageForm').addEventListener('submit', e => {
    e.preventDefault();
    if (!LOGGED_IN_TENANT) return;
    const fd = new FormData(e.target);
    const orders = LS.get(DB.orders,[]);
    orders.unshift({id: uid(),type: 'ç§Ÿå®¢ç•™è¨€',name: LOGGED_IN_TENANT.user,phone: LOGGED_IN_TENANT.phone,house: LOGGED_IN_TENANT.house,content: fd.get('content'),status: 'å¾…å¤„ç†',ts: Date.now()});
    LS.set(DB.orders, orders);
    e.target.reset();
    hideDlg('messageModal');
    alert('ç•™è¨€å·²æˆåŠŸæäº¤ç»™ç®¡ç†å‘˜ï¼');
});

// ç®¡ç†å‘˜ç™»å½•/é€€å‡º
byId('openAdmin').onclick=()=>{showDlg('loginDlg')};
byId('loginForm').addEventListener('submit',e=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  const user=fd.get('u');
  const pwd=fd.get('p');
  
  if(ADMIN_ACCOUNTS.includes(user) && pwd === ADMIN_PASSWORD){
    hideDlg('loginDlg');
    byId('main-view').style.display='none';
    byId('adminWrap').style.display='block';
    window.scrollTo(0,0);
    paintAdmin(); // ç™»å½•ååˆ·æ–°åå°æ•°æ®
  }else alert('ç™»å½•å¤±è´¥ï¼šè´¦å·æˆ–å¯†ç ä¸æ­£ç¡®');
});
byId('backFront').onclick=(e)=>{ 
    e.preventDefault(); 
    byId('main-view').style.display='block';
    byId('adminWrap').style.display='none';
    renderListing(); 
};


// ç§Ÿæˆ·ç™»å½•
byId('openUserCenter').onclick=()=>{
    showDlg('userCenterDlg');
    if (LOGGED_IN_TENANT) {
        showUserRentalInfo(LOGGED_IN_TENANT);
    } else {
        byId('rentalInfo').style.display='none';
        byId('userLoginForm').style.display='block';
    }
}
byId('userLoginForm').addEventListener('submit',e=>{
    e.preventDefault();
    const fd=new FormData(e.target);
    const inputUser = fd.get('u'); 
    const tenants = LS.get(DB.tenants, []);
    const foundTenant = tenants.find(t => t.user === inputUser || t.phone === inputUser);
    if (foundTenant) {
        LOGGED_IN_TENANT = foundTenant;
        showUserRentalInfo(foundTenant);
        alert(`ç§Ÿæˆ·ä¸­å¿ƒç™»å½•æˆåŠŸï¼æ¬¢è¿æ‚¨ï¼Œ${foundTenant.user}`);
    } else {
        alert('ç™»å½•å¤±è´¥ï¼šæœªåœ¨ç§Ÿæˆ·ç®¡ç†ç³»ç»Ÿæ‰¾åˆ°åŒ¹é…çš„ç§Ÿæˆ·ä¿¡æ¯ã€‚è¯·è”ç³»ç®¡ç†å‘˜å½•å…¥ã€‚');
        LOGGED_IN_TENANT = null;
    }
});


// åˆå§‹æ•°æ®åŠ è½½/æ¸²æŸ“ (æˆ¿æºåˆ—è¡¨)
let currentCat=CATEGORIES[0];
function renderListing(){
  const all=LS.get(DB.listings,[]);
  const availableHouses = all.filter(x => x.status === 'available');
  const rows=availableHouses.filter(x=>x.category===currentCat);
  const el=byId('listingList');
  el.innerHTML=rows.map(x=>`<div class="item"><img src="${x.img||ph()}" alt=""><div class="b"><div class="title">${x.title}</div><div class="muted">${x.category} Â· ${x.layout||""}</div><div class="price">ï¿¥${x.price}/æœˆ</div><button class="btn outline" style="width:100%;margin-top:8px;" onclick="alert('æŸ¥çœ‹æˆ¿æºï¼š${x.title}')">æŸ¥çœ‹è¯¦æƒ…</button></div></div>`).join('') || `<div class="muted" style="padding:10px;">è¯¥åˆ†ç±»æš‚æ— æˆ¿æºæˆ–å·²å…¨éƒ¨å‡ºç§Ÿã€‚</div>`;
    byId('houseCount').textContent=availableHouses.length;
    byId('noticeBar').innerHTML = 'ğŸ“¢ ' + LS.get(DB.ann);
    const aptSelect = byId('aptHouseSelect');
    aptSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ„å‘æˆ¿æº</option>' + availableHouses.map(h => `<option value="${h.title}">${h.title} (ï¿¥${h.price}/æœˆ)</option>`).join('');
}
function switchCategory(el, cat){
    document.querySelectorAll('#catTabs .tab').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
    currentCat=cat;
    renderListing();
}
byId('catTabs').innerHTML = CATEGORIES.map((cat, i) => `<button class="tab ${i===0?'active':''}" data-cat="${cat}" onclick="switchCategory(this, '${cat}')">${cat}</button>`).join('');
renderListing();
updateTenantUI(); 

// å…¶ä»–åŠŸèƒ½ 
function toggleHouseStatus(id){
    let allHouses=LS.get(DB.listings,[]);
    const house = allHouses.find(h => h.id === id);
    if(!house) return;
    house.status = house.status === 'available' ? 'rented' : 'available';
    LS.set(DB.listings,allHouses);
    alert('æˆ¿æºçŠ¶æ€å·²æ›´æ–°ä¸ºï¼š' + (house.status === 'rented' ? 'å·²å‡ºç§Ÿ' : 'ç©ºç½®/å¯ç§Ÿ'));
    paintAdmin();
    renderListing();
}
byId('addTenantForm').addEventListener('submit', e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    let tenants = LS.get(DB.tenants, []);
    const newTenant = {
        id: uid(),
        user: fd.get('name'),
        gender: fd.get('gender'),
        phone: fd.get('phone'),
        house: fd.get('house'),
        price: parseFloat(fd.get('price')), // ç¡®ä¿é‡‘é¢è¢«è¯»å–
        idcard: fd.get('idcard'),
        start: fd.get('start'),
        end: fd.get('end'),
        stars: 0,
        ts: Date.now()
    };
    tenants.unshift(newTenant);
    LS.set(DB.tenants, tenants);
    alert(`ç§Ÿæˆ· ${newTenant.user} (æˆ¿æº: ${newTenant.house}) å½•å…¥æˆåŠŸï¼`);
    e.target.reset();
    hideDlg('addTenantModal');
    paintAdmin();
});
byId('annForm').addEventListener('submit',e=>{
  e.preventDefault();
  const v=new FormData(e.target).get('txt')||"æ¬¢è¿å…¥ä½æ²ªä¹é”¦å…¬å¯“";
  LS.set(DB.ann,v); byId('noticeBar').innerHTML='ğŸ“¢ ' + v; alert('å…¬å‘Šå·²ä¿å­˜');
});

// å…¨å±€å‡½æ•°å£°æ˜ï¼Œç¡®ä¿HTML onclickå¯ä»¥è°ƒç”¨
window.showDlg=showDlg;
window.hideDlg=hideDlg;
window.switchCategory=switchCategory;
window.showHouseModal=showHouseModal;
window.toggleHouseStatus=toggleHouseStatus;
window.openContractModal=openContractModal;
window.saveContractTemplate=saveContractTemplate;
window.promptContractPrint=promptContractPrint;
window.simulateLogout=simulateLogout;
window.showMsgModal=showMsgModal;
window.markOrderAsCompleted=markOrderAsCompleted;
window.deleteContract=deleteContract;
window.saveTypedSignature=saveTypedSignature; // NEW: æ–‡æœ¬ç­¾åä¿å­˜å‡½æ•°

</script>
</body>
</html>
